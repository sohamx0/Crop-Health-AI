<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Plant Doctor - CropHealth AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .animate-fade-in { animation: fadeIn 0.7s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50">

    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-50 shadow-sm">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="/" class="text-3xl font-bold text-green-600">CropHealth AI</a>
            <div class="hidden md:flex items-center space-x-8">
                <a href="/library" class="text-gray-600 hover:text-green-600 font-medium">Disease Library</a>
            </div>
            <a href="/" class="bg-gray-600 text-white font-bold py-2 px-5 rounded-full hover:bg-gray-700 transition duration-300">Home</a>
        </nav>
    </header>

    <main class="container mx-auto px-4 py-10">
        <div class="max-w-xl mx-auto">
            <div id="upload-section" class="bg-white p-8 rounded-2xl shadow-xl text-center animate-fade-in">
                <h1 class="text-3xl font-bold text-gray-800">AI Plant Doctor</h1>
                <p class="text-gray-500 mt-2 mb-6">Upload a leaf photo for an instant, location-aware diagnosis.</p>
                <div id="uploadArea" class="border-2 border-dashed border-gray-300 rounded-xl p-10 cursor-pointer hover:bg-gray-50 transition-colors">
                    <input type="file" id="fileInput" class="hidden" accept="image/*">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                    <p class="mt-2 text-sm font-semibold text-gray-600">Click to upload or drag & drop</p>
                    <p class="text-xs text-gray-500">PNG, JPG, or JPEG</p>
                </div>
            </div>
            
            <div id="result-container" class="mt-8"></div>
        </div>
    </main>
    
    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const resultContainer = document.getElementById('result-container');

        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

        // Drag & Drop Listeners
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false);
        });
        uploadArea.addEventListener('drop', (e) => handleFile(e.dataTransfer.files[0]));

        function handleFile(file) {
            if (!file) return;

            const loaderHtml = `<div id="loader" class="text-center p-8"><p class="font-semibold text-green-600">Getting your location...</p></div>`;
            resultContainer.innerHTML = loaderHtml;
            
            // --- ‚ú® GET USER LOCATION ‚ú® ---
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        document.getElementById('loader').innerHTML = `<p class="font-semibold text-green-600">Location found! Analyzing image...</p>`;
                        uploadAndDiagnose(file, latitude, longitude);
                    },
                    (error) => {
                        console.error("Geolocation error:", error);
                        displayError("Couldn't get your location. Please enable location services in your browser and try again.");
                    }
                );
            } else {
                displayError("Geolocation is not supported by this browser.");
            }
        }

        async function uploadAndDiagnose(file, lat, lon) {
            const formData = new FormData();
            formData.append('file', file);
            // --- ‚ú® SEND COORDINATES WITH THE FILE ‚ú® ---
            formData.append('lat', lat);
            formData.append('lon', lon);
            
            try {
                const response = await fetch('/predict_disease', { method: 'POST', body: formData });
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || 'Server returned an error.');
                }
                const data = await response.json();
                displayResult(data);
            } catch (error) {
                displayError(error.message);
            }
        }
        
        function displayResult(data) {
            const { disease, confidence, is_healthy, prescription, fertilizer } = data;
            
            const cardBg = is_healthy ? 'bg-green-50 border-green-400' : 'bg-red-50 border-red-400';
            const titleColor = is_healthy ? 'text-green-800' : 'text-red-800';
            const iconSvg = is_healthy 
                ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>`;

            const confidenceHtml = !is_healthy ? `<p class="text-lg font-medium text-gray-600 mt-2">${confidence}% Confidence</p>` : '';

            // --- ‚ú® Improved formatter for the new recommendation text ‚ú® ---
            const formattedFertilizer = fertilizer.replace(/\n/g, '<br>')
                                                  .replace(/\*\*‚úÖ Recommendation:/g, '<br><strong>‚úÖ Recommendation:</strong>')
                                                  .replace(/\*\*‚ö†Ô∏è/g, '<br><strong>‚ö†Ô∏è')
                                                  .replace(/\*\*üíß/g, '<br><strong>üíß')
                                                  .replace(/\*\*üî•/g, '<br><strong>üî•');

            const resultHtml = `
                <div class="animate-fade-in">
                    <div class="result-card ${cardBg} border-t-4 p-6 rounded-2xl shadow-lg mt-4">
                        <div class="flex items-start space-x-4">
                            <div>${iconSvg}</div>
                            <div>
                                <p class="text-sm font-medium ${titleColor}">AI DIAGNOSIS</p>
                                <h3 class="text-2xl font-bold text-gray-900">${disease}</h3>
                                ${confidenceHtml}
                            </div>
                        </div>
                    </div>
                    
                    <div class="fertilizer-card bg-blue-50 border-t-4 border-blue-400 p-6 rounded-2xl shadow-lg mt-6">
                         <div class="flex items-center space-x-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-blue-500" viewBox="0 0 20 20" fill="currentColor"><path d="M17.742 2.258a.75.75 0 00-.998 0l-1.498 1.498a.75.75 0 000 1.061l.22.22a.75.75 0 001.06 0l1.498-1.498a.75.75 0 000-1.06l-.22-.22zM1.758 16.242a.75.75 0 000 .998l.22.22a.75.75 0 001.06 0l11.498-11.498a.75.75 0 000-1.06l-.22-.22a.75.75 0 00-1.06 0L1.758 16.242zM4.5 12.5a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5zM7.5 9.5a.75.75 0 00-1.5 0v5.5a.75.75 0 001.5 0v-5.5zM10.5 6.5a.75.75 0 00-1.5 0v8.5a.75.75 0 001.5 0v-8.5zM13.5 3.5a.75.75 0 00-1.5 0v11.5a.75.75 0 001.5 0V3.5z" /></svg>
                            <h4 class="text-xl font-bold text-gray-800">Location-Aware Fertilizer Plan</h4>
                         </div>
                         <p class="text-gray-600 mt-3">${formattedFertilizer}</p>
                    </div>

                     <div class="mt-6 text-center">
                        <button onclick="resetUI()" class="bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-gray-700 transition-all">Scan Another Leaf</button>
                    </div>
                </div>
            `;
            
            const loader = document.getElementById('loader');
            if (loader) {
                loader.outerHTML = resultHtml;
            } else {
                resultContainer.innerHTML = resultHtml;
            }
        }

        function displayError(message) {
             const errorHtml = `
                <div class="animate-fade-in bg-red-100 text-red-700 p-6 rounded-xl text-center mt-4">
                    <strong>Error:</strong> ${message}
                </div>
                 <div class="mt-6 text-center">
                    <button onclick="resetUI()" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700 transition-all">Try Again</button>
                </div>`;
            const loader = document.getElementById('loader');
            if (loader) {
                 loader.outerHTML = errorHtml;
            } else {
                 resultContainer.innerHTML += errorHtml;
            }
        }
        
        function resetUI() {
            fileInput.value = '';
            resultContainer.innerHTML = '';
        }
    </script>
</body>
</html>